<div class="grid">
    <div class="col-12">
        <div class="card px-6 py-6">
            <p-toast></p-toast>
            <p-toolbar styleClass="mb-4">
                <ng-template pTemplate="left">
                  <div class="my-2">
                    <button pButton pRipple label="Ajouter un nouveau projet" icon="pi pi-plus" class="p-button-success mr-2" (click)="openNew()"></button>
                    <button pButton pRipple label="Afficher le calendrier" icon="pi pi-calendar" class="p-button-info" (click)="toggleCalendar()"></button>
                  </div>
                </ng-template>
              </p-toolbar>
              
              <div *ngIf="showCalendar" class="calendar-container">
                <button (click)="toggleCalendar()" class="close-button">
                  <i class="pi pi-times"></i> <!-- Icône de croix -->
                </button>
                <full-calendar [options]="calendarOptions" class="custom-calendar"></full-calendar>
              </div>
              
               
              

              <p-table
              #dt
              [value]="projets"
              [columns]="cols"
              responsiveLayout="scroll"
              [rows]="5"
              [globalFilterFields]="['client.nom', 'client.email', 'status']"
              [paginator]="true"
              [rowsPerPageOptions]="[5, 10, 20, 30]"
              [showCurrentPageReport]="true"
              currentPageReportTemplate="Affichage de {first} à {last} sur {totalRecords} entrées"
              [(selection)]="selectedProjets"
              selectionMode="multiple"
              [rowHover]="true"
              dataKey="_id"
              expandableRows
              rowExpandMode="multiple"
            >                <ng-template pTemplate="caption">
                    <div class="flex flex-column md:flex-row md:justify-content-between md:align-items-center">
                        <h5 class="m-0" >Gérer les projets</h5>
                        <h5 class="m-0" >Nos projets</h5>
                        <span class="block mt-2 md:mt-0 p-input-icon-left">
                            <i class="pi pi-search"></i>
                            <input pInputText type="text" (input)="onGlobalFilter(dt, $event)" placeholder="Rechercher..."  class="w-full sm:w-auto"/>
                        </span>
                    </div>
                </ng-template>
                <ng-template pTemplate="header">
                    <tr>
                        <th pSortableColumn="nom">Nom <p-sortIcon field="nom"></p-sortIcon></th>
                        <th pSortableColumn="description">Description <p-sortIcon field="description"></p-sortIcon></th>
                        <th pSortableColumn="dateDebut">Date <p-sortIcon field="dateDebut"></p-sortIcon></th>
                        <th pSortableColumn="pdf">Document PDF <p-sortIcon field="pdf"></p-sortIcon></th>
                        <th pSortableColumn="ownedBy">Créer par <p-sortIcon field="ownedBy"></p-sortIcon></th>
                        <th pSortableColumn="with">Projet avec <p-sortIcon field="with"></p-sortIcon></th>
                        <th pSortableColumn="status">status <p-sortIcon field="status"></p-sortIcon></th>
                        <th *ngIf="getUserRole() === 'admin'">Modifier le status du projet <p-sortIcon ></p-sortIcon></th>

                        <th>Action</th>
                    </tr>
                </ng-template>
                <ng-template pTemplate="body" let-projet>
                    <tr>
                        <td style="width:14%; min-width:10rem;">
                            <span class="p-column-title">Nom</span>
                            {{projet.nom}}
                        </td>

                        <td style="width:14%; min-width:8rem;">
                            <span class="p-column-title">Description</span>
                            {{projet.description}}
                        </td>

                        <td style="width:14%; min-width:8rem;">
                            <span class="p-column-title">date</span>
                            {{projet.dateDebut}}
                        </td>
                        <td style="width:14%; min-width:8rem;">
                            <span class="p-column-title">PDF</span>
                            <ng-container *ngIf="projet.pdf && projet.pdf.length > 0; else noPdf">
                                <a *ngFor="let pdfFileName of projet.pdf" [href]="getPdfUrl(pdfFileName)" target="_blank" style="margin-right: 10px;">
                                    <i class="pi pi-file-pdf" style="font-size: 24px; color: red;"></i>{{projet.pdf}}
                                </a>
                            </ng-container>
                            <ng-template #noPdf>
                                <span>Aucun PDF</span>
                            </ng-template>
                        </td>     
                        <td style="width:14%; min-width:8rem;" >
                            <span class="p-column-title"></span>
                            <strong>Email:</strong>  {{ projet.ownedBy.email}}
                            <strong>Nom:</strong> {{ projet.ownedBy.nom}}
                        </td>   
                        <td style="width:14%; min-width:8rem;" >
                            <span class="p-column-title"></span>
                            <strong>Email:</strong>  {{ projet.with.email}}
                            <strong>Nom:</strong> {{ projet.with.nom}}
                        </td>               
                        <td style="width:14%; min-width:8rem;">
                            <span class="p-column-title">Status</span>
                            <span [ngClass]="{
                                'status-rejected': projet.status === 'En attente',
                                'status-confirmed': projet.status === 'Terminé',
                                'status-pending': projet.status === 'En cours'
                            }">
                                {{projet.status}}
                            </span>
                        </td>
                        
                        <td *ngIf="getUserRole() === 'admin'">
                            <span class="p-column-title">Modifier le statut</span>
                            <p-dropdown [options]="statusOptions" [(ngModel)]="selectedStatuses[projet._id]" optionLabel="label"
                                        optionValue="value" (onChange)="onStatusChange(projet, $event)" appendTo="body"></p-dropdown>
                        </td>
                        <td>
                            <div class="flex" >
                                <button pButton pRipple icon="pi pi-pencil" class="p-button-rounded p-button-success mr-2" (click)="editProjet(projet)"></button>
                                <button pButton pRipple icon="pi pi-trash" class="p-button-rounded p-button-warning" (click)="deleteProjet(projet)"></button>
                            </div>

                              
                        </td>
                    </tr>
                </ng-template>
            </p-table>
        </div>

        <p-dialog [(visible)]="projetDialog" [style]="{width: '450px'}" header="Détails du projet" [modal]="true" class="p-fluid">
            <ng-template pTemplate="content">
                <form [formGroup]="projetForm">
                    <div class="field">
                        <label for="nom">Nom</label>
                        <input type="text" pInputText id="nom" formControlName="nom" required autofocus />
                        <small *ngIf="submitted && projetForm.get('nom')?.invalid" class="ng-dirty ng-invalid">Nom est requis.</small>
                    </div>
                    <div class="field">
                        <label for="description">Description</label>
                        <textarea id="description" pInputTextarea formControlName="description" rows="3" cols="20"></textarea>
                    </div>
                    <div class="field">
                        <label for="datedateDebut">Date</label>
                        <p-calendar formControlName="dateDebut" [showIcon]="true" inputId="icon" required></p-calendar>
                        <small *ngIf="submitted && projetForm.get('dateDebut')?.invalid" class="ng-dirty ng-invalid">Date est requise.</small>
                    </div>
                    <div class="field" *ngIf="getUserRole() === 'admin'">
                        <label for="partner">Partenaire</label>
                        <p-dropdown [options]="Users" optionLabel="nom" formControlName="with" placeholder="Sélectionner un partenaire" appendTo="body"></p-dropdown>
                        <small *ngIf="submitted && projetForm.get('with')?.invalid" class="ng-dirty ng-invalid">Partenaire est requis.</small>
                    </div>
                    <div class="field" >
                        <label for="pdf">Document PDF</label>
                        <p-fileUpload mode="basic" name="pdf" accept=".pdf" maxFileSize="1000000" multiple label="Importer un fichier PDF" chooseLabel="Importer un fichier PDF" (onSelect)="onSelectPDF($event)"></p-fileUpload>
                    </div>

                </form>
                
            </ng-template>
            <ng-template pTemplate="footer">
                <button pButton pRipple label="Annuler" icon="pi pi-times" class="p-button-text" (click)="hideDialog()"></button>
                <button pButton pRipple [label]="actionLabel" icon="pi pi-check" class="p-button-text" (click)="saveProjet()"></button>
            </ng-template>
        </p-dialog>
        
          
          
          <p-dialog [(visible)]="deleteProjetDialog" header="Confirmation" [modal]="true" [style]="{width:'450px'}">
            <div class="flex align-items-center justify-content-center">
              <i class="pi pi-exclamation-triangle mr-3" style="font-size: 2rem"></i>
              <span *ngIf="projet">Voulez-vous supprimer ce rojet ?</span>
            </div>
            <ng-template pTemplate="footer">
              <button pButton pRipple icon="pi pi-times" class="p-button-text" label="Non" (click)="deleteProjetDialog = false"></button>
              <button pButton pRipple icon="pi pi-check" class="p-button-text" label="Oui" (click)="confirmDelete()"></button>
            </ng-template>
        </p-dialog>
    </div>
</div>

